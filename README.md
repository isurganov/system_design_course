# System Design Требования для Социальной Сети для Путешественников

## Оглавление
1. [Функциональные требования](#функциональные-требования)
2. [Нефункциональные требования](#нефункциональные-требования)
3. [Оценка нагрузки на систему](#оценка-нагрузки-на-систему)
4. [Архитектура системы](#архитектура-системы)
5. [Модели данных](#модели-данных)

## Функциональные требования

### 1. Публикация постов
- Возможность публикации постов из путешествий.
- Добавление фотографий и описания.
- Привязка поста к конкретному месту (геолокация).

### 2. Оценка и комментарии постов
- Возможность ставить лайки и дизлайки постам.
- Оставление комментариев под постами.
- Ответы на комментарии (nested comments).

### 3. Подписка на пользователей
- Подписка на других пользователей.
- Уведомления о новых постах и активности подписанных пользователей.

### 4. Поиск популярных мест
- Поиск популярных мест для путешествий.
- Просмотр постов из ТОП мест по странам и городам.
- Фильтрация и сортировка постов по популярности.

### 5. Личные сообщения
- Обмен личными сообщениями между пользователями.
- Уведомления о новых сообщениях.

### 6. Лента новостей
- Просмотр ленты новостей от подписанных пользователей.
- Лента должна быть динамической и обновляться в реальном времени.

## Нефункциональные требования

#### Количество пользователей
- 10 000 000 уникальных пользователей в день.
- Постоянный рост пользовательской базы за счет мощной рекламной кампании.

#### Поведение пользователей
- Высокая активность в вечерние часы и выходные. С 18 до 22 часов вечером по мск нагрузка на чтение 500 запросов/секунда и на запись 100 запросов/секунда. В выходные такая нагрузка с 10 до 22 часов по мск.
- Частое взаимодействие с функциями лайков, комментариев и личных сообщений. Чаще всего люди будут слать запросы на получение и взаимодействие с другими постами, примерно в 5 раз реже они будут сами делать посты и оформлять их.
- Просмотр и публикация фотографий и постов из путешествий.

#### Сезонности в приложении
- Пиковая активность во время праздников и туристических сезонов. В высокий сезон активность может быть на уровне 600 запросов/секунда 24 часа в сутки.

#### Регионы использования приложения
- Основная аудитория — страны СНГ.
- Поддержка русского языка и других языков региона.

#### Лимиты и ограничения
- Лимит на количество загружаемых фотографий в одном посте (например, до 10 изображений).
- Ограничение на длину текста в постах и комментариях.
- Ограничение на количество подписок и подписчиков (например, не более 5000 подписок на одного пользователя).

#### Временные ограничения
- Ограничение на частоту публикаций и комментариев для предотвращения спама (например, не более одного поста в минуту).
- Временные блокировки за нарушение правил сообщества.

### Производительность
- Время отклика сервера не более 200 мс для операций на взаимодействие с чужими постами. Не более 1000мс для создания своего поста.
- Throughput до 10 000 запросов в секунду.

### Масштабируемость
- Горизонтальная масштабируемость для поддержки растущего числа пользователей.
- Возможность увеличения мощности без значительных изменений в архитектуре.

### Надежность
- Доступность системы 99.99%.
- Минимизация времени простоя и обеспечение отказоустойчивости.

### Безопасность
- Шифрование данных пользователей.
- Защита от DDoS атак и других уязвимостей.

### Удобство использования
- Поддержка мобильных устройств и веб-браузеров.
- Интуитивно понятный интерфейс.

## Оценка нагрузки на систему

### Прогнозируемая нагрузка
- 10 000 000 уникальных пользователей в день.
- 1 000 000 одновременно активных пользователей в пиковые часы.
- 500 запросов в секунду на чтение данных в пике.
- 100 запросов в секунду на запись данных в пике.
- 300 r/w запросов в среднем.

### Пример расчета ресурсов
```plaintext
Пиковая нагрузка:
- Чтение: 500 запросов/секунда
- Запись: 100 запросов/секунда

Средний размер поста: 500KB (включая изображения)
Средний размер сообщения: 1KB

Сетевой трафик:
- Чтение: 500 * 500KB = 250MB/секунда
- Запись: 100 * 500KB = 50MB/секунда

Итого: 300MB/секунда
```

```plaintext
Приблизительного усредненный RPS с 300 запросами в секунду

RPS = 10 000 000 * 300 / 86 400 = 34722
```

## Архитектура системы

### Компоненты системы
1. **Frontend**
    - Веб-приложение (React.js)
    - Мобильное приложение (iOS/Android)

2. **Backend**
    - API сервер (Node.js/Express)
    - Сервис сообщений (WebSocket)

3. **База данных**
    - Основная база данных (PostgreSQL)
    - Кэширование (Redis)
    - Поисковый индекс (Elasticsearch)

4. **Хранилище**
    - Хранение изображений и файлов (Amazon S3)

5. **Инфраструктура**
    - Контейнеризация (Docker)
    - Оркестрация (Kubernetes)
    - Балансировка нагрузки (NGINX)
    - Мониторинг и логирование (Prometheus, Grafana)

### Диаграмма архитектуры

```plaintext
+---------------------+       +--------------------+       +--------------------+
|    Пользователь     |<----->|      Frontend      |<----->|      Backend       |
+---------------------+       +--------------------+       +--------------------+
                                    |       ^                  |        ^
                                    |       |                  |        |
                                    v       |                  v        |
                           +-----------------------+     +-----------------------+
                           |    API Gateway        |<--->|  Messaging Service    |
                           +-----------------------+     +-----------------------+
                                    |                                |
                                    v                                v
                          +------------------+                +------------------+
                          |    PostgreSQL    |                |      Redis       |
                          +------------------+                +------------------+
                                    |
                                    v
                          +------------------+
                          |   Amazon S3      |
                          +------------------+
                                    |
                                    v
                          +------------------+
                          |  Elasticsearch   |
                          +------------------+
```

#### Условия хранения данных
- Хранение данных пользователей и постов в PostgreSQL.
- Хранение изображений и медиафайлов в Amazon S3.
- Кэширование часто запрашиваемых данных в Redis.

## Модели данных

### Пользователь
```sql
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    username VARCHAR(50) UNIQUE NOT NULL,
    email VARCHAR(100) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    profile_picture_url VARCHAR(255),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### Пост
```sql
CREATE TABLE posts (
    id SERIAL PRIMARY KEY,
    user_id INT REFERENCES users(id),
    content TEXT,
    location GEOGRAPHY(POINT),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### Комментарий
```sql
CREATE TABLE comments (
    id SERIAL PRIMARY KEY,
    post_id INT REFERENCES posts(id),
    user_id INT REFERENCES users(id),
    content TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### Сообщение
```sql
CREATE TABLE messages (
    id SERIAL PRIMARY KEY,
    sender_id INT REFERENCES users(id),
    receiver_id INT REFERENCES users(id),
    content TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```